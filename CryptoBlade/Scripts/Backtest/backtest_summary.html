<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Podsumowania backtestów</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #f0f0f0;
        }

        tr:nth-child(even) {
            background: #fafafa;
        }

        a {
            color: #0074d9;
        }

        .best {
            color: #0a0;
            font-weight: bold;
        }

        .worst {
            color: #c00;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h2>Podsumowania zbiorczych backtestów</h2>
    <table id="summaryTable">
        <thead>
            <tr id="headerRow">
                <th>Data</th>
                <th>Backtest</th>
                <!-- Strategie będą dynamicznie -->
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <script>
        const summaryDir = "/Data/Strategies/_globalBacktest/";

        fetch(summaryDir)
            .then(response => response.text())
            .then(html => {
                const files = [...html.matchAll(/href="([^"]+\.json)"/g)].map(m => m[1]);
                files.sort().reverse();

                Promise.all(files.map(file =>
                    fetch(summaryDir + file)
                        .then(r => r.json())
                        .then(json => ({ file, json }))
                )).then(results => {
                    // Zbierz wszystkie strategie z wszystkich plików
                    const allStrategies = new Set();
                    results.forEach(({ json }) => {
                        if (json.Iterations) {
                            json.Iterations.forEach(iter => allStrategies.add(iter.Strategy));
                        }
                    });
                    const strategies = Array.from(allStrategies).sort();

                    // Zbuduj nagłówek
                    const headerRow = document.getElementById('headerRow');
                    strategies.forEach(strategy => {
                        const th = document.createElement('th');
                        th.textContent = strategy;
                        headerRow.appendChild(th);
                    });

                    // Zbuduj wiersze
                    const tbody = document.querySelector('#summaryTable tbody');
                    results.forEach(({ file, json }) => {
                        // Data z nazwy pliku
                        const match = file.match(/^(\d{14})-/);
                        let dateStr = "-";
                        if (match) {
                            const d = match[1];
                            dateStr = `${d.substr(0, 4)}-${d.substr(4, 2)}-${d.substr(6, 2)} ${d.substr(8, 2)}:${d.substr(10, 2)}:${d.substr(12, 2)}`;
                        }
                        const tr = document.createElement('tr');
                        // Pierwsza kolumna: data
                        const tdDate = document.createElement('td');
                        tdDate.textContent = dateStr;
                        tr.appendChild(tdDate);

                        // Druga kolumna: Backtest (zakres dat i initial balance)
                        let start = "-", end = "-", initialBalance = "-";
                        if (json.BacktestConfig && json.BacktestConfig.BackTest) {
                            start = json.BacktestConfig.BackTest.Start?.replace("T", " ") ?? "-";
                            end = json.BacktestConfig.BackTest.End?.replace("T", " ") ?? "-";
                            initialBalance = json.BacktestConfig.BackTest.InitialBalance ?? "-";
                        }
                        const tdBacktest = document.createElement('td');
                        tdBacktest.innerHTML =
                            `Od: <b>${start}</b><br>` +
                            `Do: <b>${end}</b><br>` +
                            `Initial: <b>${initialBalance}</b>`;
                        tr.appendChild(tdBacktest);

                        // Mapowanie: strategia => {FB, FE, UPnL}
                        const stratMap = {};
                        if (json.Iterations) {
                            json.Iterations.forEach(iter => {
                                stratMap[iter.Strategy] = iter;
                            });
                        }

                        // Wyznacz najlepszą/najgorszą strategię dla tego wiersza
                        let best = null, worst = null, bestVal = -Infinity, worstVal = Infinity;
                        if (json.Iterations) {
                            json.Iterations.forEach(iter => {
                                const fe = iter.FinalEquity ?? null;
                                if (fe !== null && fe !== initialBalance) {
                                    if (fe > bestVal) { bestVal = fe; best = iter.Strategy; }
                                    if (fe < worstVal) { worstVal = fe; worst = iter.Strategy; }
                                }
                            });
                        }

                        // Kolumny: strategie
                        strategies.forEach(strategy => {
                            const td = document.createElement('td');
                            if (stratMap[strategy]) {
                                const iter = stratMap[strategy];
                                td.innerHTML =
                                    `FB: <b>${iter.FinalBalance ?? '-'}</b><br>` +
                                    `FE: <b>${iter.FinalEquity ?? '-'}</b><br>` +
                                    `UPnL: <b>${iter.UnrealizedPnl ?? '-'}</b>`;
                                if (strategy === best) td.classList.add('best');
                                if (strategy === worst) td.classList.add('worst');
                            } else {
                                td.textContent = "-";
                            }
                            tr.appendChild(td);
                        });

                        tbody.appendChild(tr);
                    });
                });
            });
    </script>
</body>

</html>